<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英単語</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --check-size:26px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; background: var(--bg); color: var(--text); }
    header { position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px); background: rgba(15,23,42,0.7); border-bottom: 1px solid rgba(148,163,184,0.2); }
    .container { max-width: 980px; margin: 0 auto; padding: 16px; }
    .title { font-size: 20px; font-weight: 700; letter-spacing: .3px; }

    .toolbar { display: grid; grid-template-columns: 1fr auto auto auto auto auto; gap: 10px; margin-top: 10px; }
    @media (max-width: 720px){ .toolbar { grid-template-columns: 1fr auto auto auto; row-gap:10px; } }

    input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.25); background: #0b1220; color: var(--text); outline: none; }
    input[type="text"]::placeholder{ color: #7c8596; }
    button, label.btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.25); background: #0b1220; color: var(--text); cursor: pointer; }
    button:hover, label.btn:hover { border-color: rgba(34,211,238,0.7); }
    button.active { border-color: var(--accent); }
    button:disabled, label.btn:has(input:disabled) { opacity:.6; cursor:not-allowed; }
    .hidden { display:none !important; }

    .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .list { display: grid; grid-template-columns: 1fr; gap: 8px; padding: 16px; }
    .item { background: var(--card); border: 1px solid rgba(148,163,184,0.15); border-radius: 14px; padding: 12px; display:flex; justify-content:space-between; align-items:center; transition: transform .06s ease; }
    .item:active { transform: scale(0.99); }
    .en { font-weight: 700; min-width:0; word-break: break-word; }
    .jp { color: var(--muted); opacity: 0; transition: opacity .15s ease; margin-left: 12px; min-width:0; word-break: break-word; }
    .item.revealed .jp { opacity: 1; color: var(--text); }
    .badges { display:flex; gap:8px; align-items:center; }

    /* 左側：固定番号バッジ */
    .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .num{
      display:inline-flex; align-items:center; justify-content:center;
      font-size:12px; padding:3px 8px; border-radius:999px;
      background:rgba(34,211,238,.12); color:#7de2ee; border:1px solid rgba(34,211,238,.35);
      font-variant-numeric: tabular-nums; flex-shrink:0;
    }

    /* 正方形チェック（✓のみ） */
    .check{
      width: var(--check-size); height: var(--check-size); padding: 0;
      border: 1px solid rgba(148,163,184,0.35); border-radius: 6px;
      background: #0b1220; color: #e5e7eb; cursor: pointer;
      display: inline-grid; place-items: center; line-height: 1; flex-shrink: 0;
    }
    .check:hover { border-color: rgba(34,211,238,0.7); }
    .check.on { border-color: rgba(34,211,238,0.9); }
    .check::after { content: ''; }
    .check.on::after { content: '✓'; }

    footer { text-align:center; color: var(--muted); padding: 30px 0 60px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">英単語</div>
      <div class="toolbar">
        <input id="search" type="text" placeholder="検索：英語 / 日本語 を部分一致で絞り込み" />
        <button id="toggleAll" aria-label="すべて表示/非表示">すべて隠す</button>
        <button id="shuffle" aria-label="ランダム並び替え">シャッフル</button>
        <button id="resetOrder" aria-label="元の順に戻す">元の順に戻す</button>
        <button id="filterChecked">チェックのみ</button>
        <label class="btn" for="csvFile">CSVを読み込む<input id="csvFile" type="file" accept=".csv,.txt" class="hidden"></label>
      </div>
      <div class="hint">CSV（1列目=英語, 2列目=日本語。ヘッダ可）を読み込むと、番号は読み込んだ順で固定・チェック状態は端末内に保存されます。</div>
    </div>
  </header>

  <main class="container">
    <div id="count" class="hint">CSVを読み込んでください。</div>
    <div id="list" class="list"></div>
  </main>

  <footer>
    <div>© 状態は localStorage に保存</div>
  </footer>

  <script>
    // ===== 軽量CSVパーサ（ダブルクォート・カンマ・改行対応）=====
    function parseCSV(text) {
      const rows=[]; let row=[], cell='', inQuotes=false;
      for (let i=0;i<text.length;i++){
        const c=text[i], next=text[i+1];
        if (c === '"'){
          if (inQuotes && next === '"'){ cell+='"'; i++; }
          else { inQuotes=!inQuotes; }
        } else if (c === ',' && !inQuotes){ row.push(cell); cell=''; }
        else if ((c === '\n' || c === '\r') && !inQuotes){
          if (cell.length || row.length){ row.push(cell); rows.push(row); row=[]; cell=''; }
          if (c === '\r' && next === '\n') i++;
        } else { cell += c; }
      }
      if (cell.length || row.length){ row.push(cell); rows.push(row); }
      return rows.filter(r => r.length && (r[0] ?? '').trim() !== '');
    }

    // ===== データ／状態 =====
    const DATA_KEY  = 'wordPairs.data.v1';     // [{en,jp,_i}, ...]
    const CHECK_KEY = 'wordPairs.check.v1';    // ["en｜jp", ...] （セット）

    /** @type {{en:string, jp:string, _i:number}[]} */
    let data = [];          // 表示順を変更しても _i は固定番号
    let original = [];      // 読み込み時の順（復元用）
    let filtered = [];
    let allRevealed = false;
    let filterChecked = false;

    // チェック状態
    let checked = new Set(JSON.parse(localStorage.getItem(CHECK_KEY) || '[]'));
    const keyOf = (p) => `${p.en}｜${p.jp}`;
    const isChecked = (p) => checked.has(keyOf(p));
    function setChecked(p, on){
      if(on) checked.add(keyOf(p)); else checked.delete(keyOf(p));
      localStorage.setItem(CHECK_KEY, JSON.stringify([...checked]));
    }

    // 保存／復元
    function saveData(){ localStorage.setItem(DATA_KEY, JSON.stringify(data)); }
    function loadData(){
      try{
        const raw = localStorage.getItem(DATA_KEY);
        if(!raw) return false;
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed) || !parsed.length) return false;
        data = parsed.map((p,i)=>({ en:String(p.en), jp:String(p.jp), _i: Number.isFinite(p._i)? p._i : i }));
        data.sort((a,b)=>a._i - b._i);
        original = data.slice();
        filtered = data.slice();
        return true;
      }catch(_){ return false; }
    }

    // ===== UI 要素 =====
    const listEl  = document.getElementById('list');
    const countEl = document.getElementById('count');
    const searchEl= document.getElementById('search');
    const toggleAllBtn = document.getElementById('toggleAll');
    const shuffleBtn   = document.getElementById('shuffle');
    const resetBtn     = document.getElementById('resetOrder');
    const filterBtn    = document.getElementById('filterChecked');
    const fileInput    = document.getElementById('csvFile');

    function setButtonsEnabled(enabled){
      toggleAllBtn.disabled = !enabled;
      shuffleBtn.disabled   = !enabled;
      resetBtn.disabled     = !enabled;
      filterBtn.disabled    = !enabled;
      searchEl.disabled     = !enabled;
    }

    // ===== 描画 =====
    function renderList(items) {
      const frag = document.createDocumentFragment();
      items.forEach((pair) => {
        const div = document.createElement('div');
        div.className = 'item' + (allRevealed ? ' revealed' : '');
        div.tabIndex = 0;
        div.addEventListener('click', () => div.classList.toggle('revealed'));
        div.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); div.click(); } });

        // 左：固定番号 + 英語
        const leftWrap = document.createElement('div'); leftWrap.className = 'left';
        const num = document.createElement('span'); num.className = 'num'; num.textContent = String((pair._i ?? 0) + 1);
        const left = document.createElement('div'); left.className = 'en'; left.textContent = pair.en;
        leftWrap.appendChild(num); leftWrap.appendChild(left);

        // 日本語
        const right = document.createElement('div'); right.className = 'jp'; right.textContent = pair.jp;

        // 右端：チェック
        const badgeWrap = document.createElement('div'); badgeWrap.className = 'badges';
        const chk = document.createElement('button');
        const on = isChecked(pair);
        chk.className = 'check' + (on ? ' on' : '');
        chk.setAttribute('aria-label', on ? 'チェック済' : '未チェック');
        chk.setAttribute('role', 'checkbox');
        chk.setAttribute('aria-checked', on ? 'true' : 'false');
        chk.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const next = !isChecked(pair);
          setChecked(pair, next);
          if (filterChecked) { applySearch(); }
          else {
            chk.classList.toggle('on', next);
            chk.setAttribute('aria-checked', next ? 'true' : 'false');
          }
        });
        chk.addEventListener('keydown', (e) => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); chk.click(); } });
        badgeWrap.appendChild(chk);

        div.appendChild(leftWrap);
        div.appendChild(right);
        div.appendChild(badgeWrap);
        frag.appendChild(div);
      });
      listEl.innerHTML = '';
      listEl.appendChild(frag);

      const n = items.length;
      countEl.textContent = n ? `${n} 語（タップで日本語の表示/非表示）` : 'CSVを読み込んでください。';
      toggleAllBtn.textContent = allRevealed ? 'すべて隠す' : 'すべて表示';
      setButtonsEnabled(!!n);
    }

    // ===== 検索・フィルタ =====
    function applySearch() {
      if (!data.length) { renderList([]); return; }
      const q = (searchEl.value || '').trim().toLowerCase();
      filtered = !q ? data.slice()
                    : data.filter(p => p.en.toLowerCase().includes(q) || p.jp.toLowerCase().includes(q));
      if (filterChecked) filtered = filtered.filter(isChecked);
      renderList(filtered);
    }

    searchEl.addEventListener('input', applySearch);

    // ===== ボタン動作 =====
    toggleAllBtn.addEventListener('click', () => {
      allRevealed = !allRevealed;
      document.querySelectorAll('.item').forEach(el => el.classList.toggle('revealed', allRevealed));
      toggleAllBtn.textContent = allRevealed ? 'すべて隠す' : 'すべて表示';
    });

    shuffleBtn.addEventListener('click', () => {
      for (let i = data.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [data[i], data[j]] = [data[j], data[i]];
      }
      applySearch();
      saveData();
    });

    resetBtn.addEventListener('click', () => {
      data = original.slice();     // 読み込み時の配列順に戻す
      applySearch();
      saveData();
    });

    filterBtn.addEventListener('click', ()=> {
      filterChecked = !filterChecked;
      filterBtn.classList.toggle('active', filterChecked);
      filterBtn.textContent = filterChecked ? 'チェックのみ解除' : 'チェックのみ';
      applySearch();
    });

    // ===== CSV読み込み（ユーザー指定）=====
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      const rows = parseCSV(text).filter(r => r.length >= 2);
      if (!rows.length){ alert('CSVが空です'); return; }

      // ヘッダ判定
      const first = rows[0].map(s => (s || '').trim().toLowerCase());
      const hasHeader =
        (first[0]?.includes('english') || first[0]?.includes('en') || first[0]?.includes('word') || first[0]?.includes('単語')) ||
        (first[1]?.includes('japanese') || first[1]?.includes('jp') || first[1]?.includes('訳'));
      const start = hasHeader ? 1 : 0;

      const parsed = [];
      for (let i = start; i < rows.length; i++){
        const en = (rows[i][0] || '').trim();
        const jp = (rows[i][1] || '').trim();
        if (!en || !jp) continue;
        parsed.push({ en, jp });
      }
      if (!parsed.length){ alert('有効なデータが見つかりませんでした。（1列目=英語, 2列目=日本語）'); return; }

      data = parsed.map((p, i) => ({ ...p, _i: i }));   // 読み込み順の固定番号
      original = data.slice();
      filtered = data.slice();
      allRevealed = false;                               // 学習向けに読み込み後は隠す
      searchEl.value = '';
      saveData();                                       // データ保存
      renderList(filtered);
    });

    // ===== 初期化 =====
    const restored = loadData();
    setButtonsEnabled(restored);
    renderList(restored ? data : []);
  </script>
</body>
</html>
